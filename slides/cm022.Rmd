---
title: "CONJ620: CM 2.2"
subtitle: "Coding Style"
author: "Alison Hill + Grace Lawley"
output:
  xaringan::moon_reader:
    css: ["default", "css/ohsu.css", "css/ohsu-fonts.css"]
    lib_dir: libs
    nature:
      highlightStyle: atelier-lakeside-light
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "https://platform.twitter.com/widgets.js"
---

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(extrafont)
```

```{r data, include = FALSE}
crimenames <- c("county", "region_name", "region_code",
               "criminals", "public_houses", "school_attendance",
               "worship_attendance")

crime <- read_table(here::here("data", "beerhall.dat"),
                    col_names = crimenames)
# For ggplot2
ggplot2::theme_set(ggplot2::theme_minimal() +
                   ggplot2::theme(text = element_text(family = "Lato")))
```

```{r setup, include=FALSE}
# R options
options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE,     # for regression output
  warn = 1
  )
# Set dpi and height for images
knitr::opts_chunk$set(fig.height = 3, fig.width = 5.5, dpi = 300) 
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
# For magick
dev.off <- function(){
  invisible(grDevices::dev.off())
}
```

class: center, middle

# Coding style

---

## Style guide

>"Good coding style is like correct punctuation: you can manage without it, butitsuremakesthingseasiertoread."
>
>Hadley Wickham

- Style guide for this course is based on the Tidyverse style guide: http://style.tidyverse.org/

- There's more to it than what we'll cover today, but we'll mention more as we introduce more functionality, and do a recap later in the semester

---

## File names and code chunk labels

- Do not use spaces in file names, use `-` or `_` to separate words
- Use all lowercase letters

```{r eval = FALSE}
# Good
ucb-admit.csv

# Bad
UCB Admit.csv
```

---

## Object names

- Use `_` to separate words in object names
- Use informative but short object names
- Do not reuse object names within an analysis

```{r eval = FALSE}
# Good
acs_employed

# Bad
acs.employed
acs2
acs_subset
acs_subsetted_for_males
```

---

## Spacing

- Put a space before and after all infix operators (=, +, -, <-, etc.), and when naming arguments in function calls. 
- Always put a space after a comma, and never before (just like in regular English).

```{r eval = FALSE}
# Good
average <- mean(feet / 12 + inches, na.rm = TRUE)

# Bad
average<-mean(feet/12+inches,na.rm=TRUE)
```

---

## ggplot

- Always end a line with `+`
- Always indent the next line

```{r eval = FALSE}
# Good
ggplot(diamonds, mapping = aes(x = price)) +
  geom_histogram()

# Bad
ggplot(diamonds,mapping=aes(x=price))+geom_histogram()
```

---

## Long lines

- Limit your code to 80 characters per line. This fits comfortably on a printed page with a reasonably sized font.

- Take advantage of RStudio editor's auto formatting for indentation at line breaks.

---

## Assignment

- Use `<-` not `=`

```{r eval = FALSE}
# Good
x <- 2

# Bad
x = 2
```

---

## Quotes

Use `"`, not `'`, for quoting text. The only exception is when the text already contains double quotes and no single quotes.

```{r eval = FALSE}
ggplot(diamonds, mapping = aes(x = price)) +
  geom_histogram() +
  # Good
  labs(title = "`Shine bright like a diamond`",
  # Good
       x = "Diamond prices",
  # Bad
       y = 'Frequency')
```

---
## Back to linear models

---

## Vocabulary

- **Response variable:** Variable whose behavior or variation you are trying to understand, on the y-axis (dependent variable)

--

- **Explanatory variables:** Other variables that you want to use to explain the variation in the response, on the x-axis (independent variables)

--

- **Predicted value:** Output of the function **model function**
    - The model function gives the typical value of the response variable
    *conditioning* on the explanatory variables

--

- **Residuals:** Show how far each case is from its model value
    - Residual = Observed value - Predicted value
    - Tells how far above/below the model function each case is

---

## Criminals as a function of public houses


Describe the relationship between public houses and criminals.

$$\widehat{\textrm{criminals}} = b_0 + b_1~\textrm{public_houses}$$


```{r echo=FALSE}
ggplot(crime, aes(x = public_houses, y = criminals)) +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", colour = "dodgerblue") + # lm for linear model
  labs(title = "Criminals vs. public houses", subtitle = "Just the data") 
```

---

## Use your words


Do this in three sentences: 
There seems to be a moderately strong relationship. The slope of the regresion line is positive, also the correlation coefficient of `r round(cor(crime$public_houses, crime$criminals),2)` is moderate. Meaning as public houses increase, there is an associated increase in criminal activity.


```{r echo=FALSE}
ggplot(crime, aes(x = public_houses, y = criminals)) +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", colour = "dodgerblue") + # lm for linear model
  labs(title = "Observed + line + error") 
```
---

## Visualizing the linear model

... without the measure of uncertainty around the line

```{r echo=FALSE}
ggplot(crime, aes(x = public_houses, y = criminals)) +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", colour = "dodgerblue", se = FALSE) + # lm for linear model
  labs(title = "Observed + line") 
```

---

## Visualizing the linear model

Caution: extrapolating...

```{r echo=FALSE}
ggplot(crime, aes(x = public_houses, y = criminals)) +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", colour = "dodgerblue", se = FALSE, 
              fullrange = TRUE) + 
  labs(title = "Observed + line + fullrange") +
  coord_cartesian(xlim = c(0, 805)) +
  scale_x_continuous(expand=c(0,0), limits=c(0,805))
```
---

## Residuals

What does a negative residual mean? 

Which counties on the plot have negative residuals, those below or above the line?


```{r echo=FALSE}
ggplot(crime, aes(x = public_houses, y = criminals)) +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", colour = "dodgerblue", se = FALSE) # lm for linear model
```

---

## Models - upsides and downsides

- Models can sometimes reveal patterns that are not evident in a graph of the
data. This is a great advantage of modelling over simple visual inspection of
data. 

- There is a real risk, however, that a model is imposing structure that is
not really there on the scatter of data, just as people imagine animal shapes in
the stars. A skeptical approach is always warranted.

---

## Variation around the model...

is just as important as the model, if not more!

*Statistics is the explanation of variation in the context of what remains
unexplained.*

- The scatter suggests that there might be other factors that account for large parts 
of painting-to-painting variability, or perhaps just that randomness plays a big role.

- Adding more explanatory variables to a model can sometimes usefully reduce
the size of the scatter around the model. (We'll talk more about this later.)

---
## Criminals & public houses

```{r}
(crime_from_ph <- lm(criminals ~ public_houses, data = crime))
```

--

<br>

$$\widehat{\textrm{criminals}} = 109.34 + .12~\textrm{public_houses}$$
--

- **Slope:** For each additional public house per 100k people, the crime per 100k people is expected to be higher, on average, by 0.12.

--

- **Intercept:** Counties with 0 public houses are expected to have crime rates at 109.34 per 100k people, on average.
    - Does this make sense?

---
## Intercept

- **Intercept:** Counties with 0 public houses are expected to have crime rates at 109.34 per 100k people, on average.
    - Does this make sense? 
    - Do we have any counties with 0?
    
```{r}
crime %>% 
  filter(public_houses == 0)
```

While the intercept has a mathematical interpretation (it situates the vertical location of the line), it may not always have a practical one.

---

## The linear model with a single predictor

- We're interested in the $\beta_0$ (population parameter for the intercept)
and the $\beta_1$ (population parameter for the slope) in the 
following model:

$$ \hat{y} = \beta_0 + \beta_1~x $$

--

- But we can't measure the whole population...

--

- So we use the sample statistics to estimate them:

$$ \hat{y} = b_0 + b_1~x $$

---

## Least squares regression

The regression line minimizes the sum of squared residuals.

--

If $e_i = y - \hat{y}$,

then, the regression line minimizes $\sum_{i = 1}^n e_i^2$.

---

## Visualizing residuals

```{r echo = FALSE}
crime_scatter <- ggplot(crime, aes(public_houses, criminals)) +
  geom_smooth(method = "lm", se = FALSE, colour = "dodgerblue") +  
  geom_point(size = 2, color = "navy", alpha = .8) +
  labs(title = "Observed + line") 
crime_scatter
```


---

## Visualizing residuals (cont.)

```{r echo = FALSE}
ggplot(crime, aes(public_houses, criminals)) +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", se = FALSE, colour = "dodgerblue") +  
  geom_point(aes(x = public_houses, 
                 y = predict(lm(criminals ~ public_houses))),
             fill = "dodgerblue",
             size = 2,
             shape = 21)  +
  labs(subtitle = "Observed + line + predicted") 
```

---

## Visualizing residuals (cont.)

```{r echo = FALSE}
ggplot(crime, aes(public_houses, criminals)) +
  geom_segment(aes(x = public_houses, 
                   xend = public_houses, 
                   y = criminals, 
                   yend = predict(lm(criminals ~ public_houses))), 
               colour = "red") +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_smooth(method = "lm", se = FALSE, colour = "dodgerblue") +  
  geom_point(aes(x = public_houses, 
                 y = predict(lm(criminals ~ public_houses))),
             fill = "dodgerblue",
             size = 2,
             shape = 21)  +
  labs(subtitle = "Observed + line + predicted + residuals") 
```



---

## Properties of the least squares regression line

- The regression line goes through the center of mass point, the coordinates corresponding to average $x$ and average $y$: $(\bar{x}, \bar{y})$:

$$\hat{y} = b_0 + b_1 x ~ \rightarrow ~ b_0 = \hat{y} - b_1 x$$

- The slope has the same sign as the correlation coefficient:

$$b_1 = r \frac{s_y}{s_x}$$

- The sum of the residuals is zero: 
$$\sum_{i = 1}^n e_i = 0$$

- The residuals and $x$ values are uncorrelated.

---
## The means

```{r echo = FALSE}
crime_scatter +
  geom_vline(aes(xintercept = mean(public_houses)), 
             color = "turquoise") +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  labs(title = "Observed + line", subtitle = "Plus both means")
```

---
## A thought experiment...

```{r echo = FALSE}
crime_scatter +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  labs(subtitle = "Add mean of criminals, the dependent variable (DV)")
```

---
## A thought experiment...

"The turquoise points are what we would expect to see if there was `___` association between `public_houses` and `criminals`"

```{r echo = FALSE}
crime_scatter +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  geom_point(aes(x = public_houses, 
             y = mean(criminals)),
             fill = "turquoise",
             size = 2,
             shape = 21) +
  labs(subtitle = "Add mean criminal values")
```
---
## A thought experiment...

"The bright blue points are what we would expect to see if there was `___` a `___` of `r round(cor(crime$criminals, crime$public_houses), 2)` between `public_houses` and `criminals`"

```{r echo = FALSE}
crime_scatter +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  geom_point(aes(x = public_houses, 
             y = mean(criminals)),
             fill = "turquoise",
             size = 2,
             shape = 21) +
  geom_point(aes(x = public_houses, 
             y = predict(lm(criminals ~ public_houses))),
             fill = "dodgerblue",
             size = 2,
             shape = 21) +
  labs(subtitle = "Add fitted/predicted criminal values")
```

---
## A thought experiment...

We are looking at **THREE** models!

1. Zero association between the variables (aka, the mean model, aka the null model)
2. An exact association of `r round(cor(crime$criminals, crime$public_houses), 2)` between the variables
3. The actual data-generating model (this will always be unknown to us!)

```{r echo = FALSE}
crime_scatter +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  geom_point(aes(x = public_houses, 
             y = mean(criminals)),
             fill = "turquoise",
             size = 2,
             shape = 21) +
  geom_point(aes(x = public_houses, 
             y = predict(lm(criminals ~ public_houses))),
             fill = "dodgerblue",
             size = 2,
             shape = 21) +
  labs(subtitle = NULL, title = NULL)
```

---
## A thought experiment...

Where are the residuals here?

--

```{r echo = FALSE}
crime_scatter +
  geom_segment(aes(x = public_houses, 
                   xend = public_houses, 
                   y = criminals, 
                   yend = predict(lm(criminals ~ public_houses))), 
               colour = "red") +
  geom_point(aes(x = public_houses, 
             y = predict(lm(criminals ~ public_houses))),
             fill = "dodgerblue",
             size = 2,
             shape = 21) +
  labs(subtitle = NULL, title = NULL)
```

---
## A thought experiment...

Are there any other "differences" we can calculate with this set of 3 points/models?

```{r echo = FALSE}
crime_scatter +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  geom_point(aes(x = public_houses, 
             y = mean(criminals)),
             fill = "turquoise",
             size = 2,
             shape = 21) +
  geom_point(aes(x = public_houses, 
             y = predict(lm(criminals ~ public_houses))),
             fill = "dodgerblue",
             size = 2,
             shape = 21) +
  labs(subtitle = NULL, title = NULL)
```

---
## A thought experiment...

Ignore the regression line/predicted points: What would the magnitude of the differences between the observed `criminals` values and the mean value tell us? *(remember what we said the mean line represented: `___` correlation between variables)*

--

```{r echo = FALSE}
ggplot(crime, aes(x = public_houses, y = criminals)) +
  geom_segment(aes(x = public_houses, 
                   xend = public_houses, 
                   y = criminals, 
                   yend = mean(criminals)), 
               colour = "orchid") +
  geom_point(size = 2, color = "navy", alpha = .8) +
  geom_hline(aes(yintercept = mean(criminals)),
             color = "turquoise") +
  geom_point(aes(x = public_houses, 
             y = mean(criminals)),
             fill = "turquoise",
             size = 2,
             shape = 21) +
  labs(subtitle = NULL, title = NULL)
```